<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <button id="download">下载索引</button>
    <script src="./js/util/saveData.js"></script>
    <script src="./js/index/file_path_idx.js"></script>
    <script>
        let log = console.log.bind(console)

        // 异步请求
        let httpRequest = function (url) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4) {
                        resolve(JSON.parse(xhr.responseText));
                    }
                }
                xhr.send();
            })
        }

        let contentCutIndex = function (source) {
            if (!source || !source.length) {
                return 0
            }
            const cutChar = ['，', '。', '？', '！']
            let minIdx = source.length
            for (let i = 0; i < cutChar.length; i++) {
                let cutIndex = source.indexOf(cutChar[i])
                if (cutIndex != -1) {
                    minIdx = Math.min(minIdx, cutIndex)
                }
            }

            return minIdx;
        }

        let main_author = ["苏轼", "李白", "陆游", "王维", "杜甫", "杜牧", "屈原", "柳永", "李煜", "王勃", "李贺", "秦观", "曹操", "曹植", "李商隐", "辛弃疾", "李清照", "白居易", "陶渊明", "温庭筠", "欧阳修", "晏几道", "刘禹锡", "孟浩然"]
        let is_main_index = true

        let fullIndex = {}
        file_path_idx.forEach((path, f_idx) => {
            httpRequest(`/source/${path}`).then(data => {
                console.log(path)
                console.log(data.length)
                let currIndex = {}
                data.map((item, i_idx) => {
                    if (is_main_index) {
                        if (main_author.includes(item.authorName)) {
                            currIndex[
                                `${item.dynasty}-${item.title}-${item.authorName}-${item.content ? item.content[0].substr(0, contentCutIndex(item.content[0])) : ''}`
                            ] = `${f_idx}-${i_idx}`
                        }
                    } else {
                        currIndex[
                            `${item.dynasty}-${item.title}-${item.authorName}-${item.content ? item.content[0].substr(0, contentCutIndex(item.content[0])) : ''}`
                        ] = `${f_idx}-${i_idx}`
                    }

                })

                return currIndex
            }).then(idx_list => {
                Object.assign(fullIndex, idx_list)
            })
        });


        download.onclick = function () {
            // saveData.setDataConver({ name: 'full_data_index.json', data: JSON.stringify(fullIndex, null, 2) })
            saveData.setDataConver({ name: 'full_data_index.json', data: JSON.stringify(fullIndex) })
        }

    </script>
</body>

</html>